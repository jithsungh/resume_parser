<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Segmentation Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        color: #333;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: -9999px;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        font-weight: 500;
      }

      .btn-primary {
        background: white;
        color: #667eea;
      }

      .btn-primary:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .file-selector {
        flex: 1;
        min-width: 200px;
      }

      .file-selector select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 0.9rem;
      }

      .file-selector select option {
        background: #667eea;
        color: white;
      }

      .stats {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      /* Main Content */
      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* PDF Panel */
      .pdf-panel {
        flex: 0 0 50%;
        display: flex;
        flex-direction: column;
        background: white;
        border-right: 1px solid #ddd;
      }

      .pdf-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f9f9f9;
        border-bottom: 1px solid #ddd;
      }

      .pdf-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .pdf-controls button {
        padding: 0.4rem 0.8rem;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .pdf-controls button:hover {
        background: #f0f0f0;
      }

      .pdf-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-info {
        font-size: 0.85rem;
        color: #666;
      }

      .pdf-viewer {
        flex: 1;
        overflow: auto;
        background: #525659;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem;
      }

      #pdf-canvas {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        background: white;
        max-width: 100%;
        height: auto;
      }

      .pdf-placeholder {
        text-align: center;
        color: #999;
        padding: 4rem 2rem;
      }

      .pdf-placeholder svg {
        width: 100px;
        height: 100px;
        opacity: 0.3;
        margin-bottom: 1rem;
      }

      /* Sections Panel */
      .sections-panel {
        flex: 0 0 50%;
        display: flex;
        flex-direction: column;
        background: #fafafa;
      }

      .sections-toolbar {
        padding: 0.75rem 1rem;
        background: white;
        border-bottom: 1px solid #ddd;
      }

      .filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-group label {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
      }

      .filter-group select,
      .filter-group input {
        padding: 0.4rem 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      .filter-group input[type="checkbox"] {
        width: auto;
      }

      .sections-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }

      .section-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        cursor: pointer;
      }

      .section-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .section-card.active {
        border-left: 4px solid #667eea;
        background: #f0f4ff;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
      }

      .section-title {
        font-weight: 600;
        font-size: 1rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .section-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-known {
        background: #d4edda;
        color: #155724;
      }

      .badge-unknown {
        background: #fff3cd;
        color: #856404;
      }

      .section-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 0.75rem;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .section-content {
        background: #f9f9f9;
        border-left: 3px solid #e0e0e0;
        padding: 0.75rem;
        border-radius: 4px;
        font-size: 0.9rem;
        line-height: 1.6;
        color: #555;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }

      .section-content.expanded {
        max-height: none;
      }

      .expand-btn {
        color: #667eea;
        cursor: pointer;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: inline-block;
      }

      .expand-btn:hover {
        text-decoration: underline;
      }

      .no-sections {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
      }

      /* Loading Spinner */
      .loading {
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .main-content {
          flex-direction: column;
        }

        .pdf-panel,
        .sections-panel {
          flex: 1 1 50%;
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üìÑ Resume Segmentation Viewer</h1>
        <div class="controls">
          <div class="file-input-wrapper">
            <label for="jsonFile" class="btn btn-primary">
              üìÅ Load Batch JSON
            </label>
            <input type="file" id="jsonFile" accept=".json" />
          </div>

          <div
            class="file-selector"
            id="fileSelectorWrapper"
            style="display: none"
          >
            <select id="fileSelect">
              <option value="">Select a resume...</option>
            </select>
          </div>

          <button
            class="btn btn-secondary"
            id="exportBtn"
            style="display: none"
          >
            üíæ Export Current
          </button>

          <div class="stats" id="statsDisplay" style="display: none">
            <div class="stat-item">
              <span>üìä</span>
              <span id="totalFiles">0</span> files
            </div>
            <div class="stat-item">
              <span>üìë</span>
              <span id="totalSections">0</span> sections
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- PDF Panel -->
        <div class="pdf-panel">
          <div class="pdf-toolbar">
            <div class="pdf-controls">
              <button id="prevPage">‚Üê Prev</button>
              <span class="page-info">
                Page <span id="pageNum">-</span> / <span id="pageCount">-</span>
              </span>
              <button id="nextPage">Next ‚Üí</button>
              <button id="zoomOut">-</button>
              <span class="page-info"><span id="zoomLevel">100</span>%</span>
              <button id="zoomIn">+</button>
            </div>
          </div>
          <div class="pdf-viewer" id="pdfViewer">
            <div class="pdf-placeholder">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                />
              </svg>
              <p>Load a JSON file to view PDFs</p>
            </div>
            <canvas id="pdf-canvas" style="display: none"></canvas>
          </div>
        </div>

        <!-- Sections Panel -->
        <div class="sections-panel">
          <div class="sections-toolbar">
            <div class="filters">
              <div class="filter-group">
                <label>Section:</label>
                <select id="sectionFilter">
                  <option value="all">All Sections</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Content:</label>
                <select id="contentFilter">
                  <option value="all">All</option>
                  <option value="nonempty">Non-empty</option>
                  <option value="empty">Empty</option>
                </select>
              </div>
              <div class="filter-group">
                <label>
                  <input type="checkbox" id="unknownOnly" />
                  Unknown Only
                </label>
              </div>
              <div class="filter-group">
                <label>Search:</label>
                <input
                  type="text"
                  id="searchBox"
                  placeholder="Search content..."
                />
              </div>
            </div>
          </div>
          <div class="sections-list" id="sectionsList">
            <div class="no-sections">
              <p>No sections to display</p>
              <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.7">
                Load a JSON file and select a resume to begin
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configure PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      // State
      let batchData = null;
      let currentFileIndex = -1;
      let currentPdf = null;
      let currentPage = 1;
      let totalPages = 0;
      let zoomLevel = 1.0;
      let currentSections = [];

      // DOM Elements
      const jsonFileInput = document.getElementById("jsonFile");
      const fileSelect = document.getElementById("fileSelect");
      const fileSelectorWrapper = document.getElementById(
        "fileSelectorWrapper"
      );
      const statsDisplay = document.getElementById("statsDisplay");
      const exportBtn = document.getElementById("exportBtn");
      const pdfViewer = document.getElementById("pdfViewer");
      const pdfCanvas = document.getElementById("pdf-canvas");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const zoomInBtn = document.getElementById("zoomIn");
      const zoomOutBtn = document.getElementById("zoomOut");
      const pageNumSpan = document.getElementById("pageNum");
      const pageCountSpan = document.getElementById("pageCount");
      const zoomLevelSpan = document.getElementById("zoomLevel");
      const sectionsList = document.getElementById("sectionsList");
      const sectionFilter = document.getElementById("sectionFilter");
      const contentFilter = document.getElementById("contentFilter");
      const unknownOnlyCheckbox = document.getElementById("unknownOnly");
      const searchBox = document.getElementById("searchBox");

      // Event Listeners
      jsonFileInput.addEventListener("change", handleFileLoad);
      fileSelect.addEventListener("change", handleFileSelect);
      prevPageBtn.addEventListener("click", () => changePage(-1));
      nextPageBtn.addEventListener("click", () => changePage(1));
      zoomInBtn.addEventListener("click", () => changeZoom(0.1));
      zoomOutBtn.addEventListener("click", () => changeZoom(-0.1));
      sectionFilter.addEventListener("change", filterSections);
      contentFilter.addEventListener("change", filterSections);
      unknownOnlyCheckbox.addEventListener("change", filterSections);
      searchBox.addEventListener("input", filterSections);
      exportBtn.addEventListener("click", exportCurrentResume);

      // Load JSON file
      function handleFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            loadBatchData(data);
          } catch (error) {
            alert("Error parsing JSON file: " + error.message);
          }
        };
        reader.readAsText(file);
      }

      // Load batch data
      function loadBatchData(data) {
        // Handle different JSON formats
        if (Array.isArray(data)) {
          // Old list format
          batchData = {
            metadata: {
              total_files: data.length,
              successful: data.length,
              failed: 0,
            },
            results: data.map((item) => ({
              file_name: item.file_name || "unknown",
              file_path: item.file_path || "",
              success: true,
              result: item,
            })),
          };
        } else if (data.file_path && data.sections) {
          // Single resume format
          batchData = {
            metadata: {
              total_files: 1,
              successful: 1,
              failed: 0,
            },
            results: [
              {
                file_name: data.file_name || "Resume",
                file_path: data.file_path,
                success: true,
                result: data,
              },
            ],
          };
        } else if (data.results) {
          // Batch format
          batchData = data;
        } else {
          alert("Unknown JSON format");
          return;
        }

        populateFileSelector();
        updateStats();
        fileSelectorWrapper.style.display = "block";
        statsDisplay.style.display = "flex";
        exportBtn.style.display = "block";
      }

      // Populate file selector
      function populateFileSelector() {
        fileSelect.innerHTML = '<option value="">Select a resume...</option>';

        batchData.results.forEach((result, index) => {
          if (result.success) {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = result.file_name;
            fileSelect.appendChild(option);
          }
        });
      }

      // Update stats
      function updateStats() {
        const metadata = batchData.metadata || {};
        document.getElementById("totalFiles").textContent =
          metadata.total_files || 0;

        let totalSections = 0;
        batchData.results.forEach((result) => {
          if (result.success && result.result.sections) {
            totalSections += result.result.sections.length;
          }
        });
        document.getElementById("totalSections").textContent = totalSections;
      }

      // Handle file selection
      function handleFileSelect(event) {
        const index = parseInt(event.target.value);
        if (isNaN(index)) return;

        currentFileIndex = index;
        const result = batchData.results[index];

        if (!result.success) {
          alert("Error loading file: " + (result.error || "Unknown error"));
          return;
        }

        loadResume(result);
      }

      // Load resume
      function loadResume(result) {
        // Load PDF
        const pdfPath = result.file_path;
        if (pdfPath && pdfPath.endsWith(".pdf")) {
          loadPDF(pdfPath);
        } else {
          showPDFPlaceholder("PDF not available");
        }

        // Load sections
        currentSections = result.result.sections || [];
        const unknownSections = result.result.unknown_sections || [];

        // Mark unknown sections
        currentSections.forEach((section) => {
          section.is_unknown = unknownSections.some(
            (u) => u.section_name === section.section_name
          );
        });

        populateSectionFilter();
        displaySections();
      }

      // Load PDF
      async function loadPDF(pdfPath) {
        try {
          if (currentPdf) {
            currentPdf.destroy();
          }

          // Show loading
          pdfViewer.querySelector(".pdf-placeholder").style.display = "block";
          pdfCanvas.style.display = "none";

          const loadingTask = pdfjsLib.getDocument(pdfPath);
          currentPdf = await loadingTask.promise;
          totalPages = currentPdf.numPages;
          currentPage = 1;

          pageCountSpan.textContent = totalPages;
          prevPageBtn.disabled = false;
          nextPageBtn.disabled = false;

          renderPage(currentPage);
        } catch (error) {
          console.error("Error loading PDF:", error);
          showPDFPlaceholder("Error loading PDF: " + error.message);
        }
      }

      // Render PDF page
      async function renderPage(pageNum) {
        if (!currentPdf) return;

        try {
          const page = await currentPdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: zoomLevel });

          const canvas = pdfCanvas;
          const context = canvas.getContext("2d");
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };

          await page.render(renderContext).promise;

          pdfViewer.querySelector(".pdf-placeholder").style.display = "none";
          pdfCanvas.style.display = "block";

          pageNumSpan.textContent = pageNum;
          prevPageBtn.disabled = pageNum <= 1;
          nextPageBtn.disabled = pageNum >= totalPages;
        } catch (error) {
          console.error("Error rendering page:", error);
        }
      }

      // Change page
      function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          renderPage(currentPage);
        }
      }

      // Change zoom
      function changeZoom(delta) {
        zoomLevel = Math.max(0.5, Math.min(3.0, zoomLevel + delta));
        zoomLevelSpan.textContent = Math.round(zoomLevel * 100);
        if (currentPdf) {
          renderPage(currentPage);
        }
      }

      // Show PDF placeholder
      function showPDFPlaceholder(message) {
        const placeholder = pdfViewer.querySelector(".pdf-placeholder");
        placeholder.style.display = "block";
        placeholder.querySelector("p").textContent = message;
        pdfCanvas.style.display = "none";
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
      }

      // Populate section filter
      function populateSectionFilter() {
        const sectionNames = new Set();
        currentSections.forEach((section) => {
          sectionNames.add(section.section_name);
        });

        sectionFilter.innerHTML = '<option value="all">All Sections</option>';
        Array.from(sectionNames)
          .sort()
          .forEach((name) => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            sectionFilter.appendChild(option);
          });
      }

      // Display sections
      function displaySections() {
        const filteredSections = getFilteredSections();

        if (filteredSections.length === 0) {
          sectionsList.innerHTML =
            '<div class="no-sections"><p>No sections match the filters</p></div>';
          return;
        }

        sectionsList.innerHTML = "";

        filteredSections.forEach((section, index) => {
          const card = createSectionCard(section, index);
          sectionsList.appendChild(card);
        });
      }

      // Get filtered sections
      function getFilteredSections() {
        let filtered = currentSections;

        // Section name filter
        const selectedSection = sectionFilter.value;
        if (selectedSection !== "all") {
          filtered = filtered.filter((s) => s.section_name === selectedSection);
        }

        // Content filter
        const contentFilterValue = contentFilter.value;
        if (contentFilterValue === "nonempty") {
          filtered = filtered.filter(
            (s) => s.content && s.content.trim().length > 0
          );
        } else if (contentFilterValue === "empty") {
          filtered = filtered.filter(
            (s) => !s.content || s.content.trim().length === 0
          );
        }

        // Unknown only filter
        if (unknownOnlyCheckbox.checked) {
          filtered = filtered.filter((s) => s.is_unknown);
        }

        // Search filter
        const searchQuery = searchBox.value.toLowerCase().trim();
        if (searchQuery) {
          filtered = filtered.filter((s) => {
            const content = (s.content || "").toLowerCase();
            const sectionName = s.section_name.toLowerCase();
            return (
              content.includes(searchQuery) || sectionName.includes(searchQuery)
            );
          });
        }

        return filtered;
      }

      // Create section card
      function createSectionCard(section, index) {
        const card = document.createElement("div");
        card.className = "section-card";

        const content = section.content || "";
        const fullText = section.full_text || content;
        const isLong = content.length > 200;

        card.innerHTML = `
                <div class="section-header">
                    <div class="section-title">
                        <span>${section.section_name}</span>
                        <span class="section-badge ${
                          section.is_unknown ? "badge-unknown" : "badge-known"
                        }">
                            ${section.is_unknown ? "‚ö†Ô∏è Unknown" : "‚úì Known"}
                        </span>
                    </div>
                </div>
                <div class="section-meta">
                    <div class="meta-item">
                        üìÑ Page ${(section.page || 0) + 1}
                    </div>
                    <div class="meta-item">
                        üìê Column ${(section.column_id || 0) + 1}
                    </div>
                    <div class="meta-item">
                        üìè ${section.line_count || 0} lines
                    </div>
                    <div class="meta-item">
                        ${content.length} chars
                    </div>
                </div>
                <div class="section-content" id="content-${index}">
                    ${
                      isLong
                        ? content.substring(0, 200) + "..."
                        : content || "<em>No content</em>"
                    }
                </div>
                ${
                  isLong
                    ? `<span class="expand-btn" onclick="toggleExpand(${index})">Show more</span>`
                    : ""
                }
            `;

        // Click to jump to page
        card.addEventListener("click", () => {
          const pageNum = (section.page || 0) + 1;
          if (pageNum <= totalPages && currentPdf) {
            currentPage = pageNum;
            renderPage(currentPage);

            // Highlight active card
            document
              .querySelectorAll(".section-card")
              .forEach((c) => c.classList.remove("active"));
            card.classList.add("active");
          }
        });

        return card;
      }

      // Toggle expand
      window.toggleExpand = function (index) {
        const section = getFilteredSections()[index];
        const contentDiv = document.getElementById(`content-${index}`);
        const isExpanded = contentDiv.classList.contains("expanded");

        if (isExpanded) {
          contentDiv.classList.remove("expanded");
          contentDiv.textContent = section.content.substring(0, 200) + "...";
          event.target.textContent = "Show more";
        } else {
          contentDiv.classList.add("expanded");
          contentDiv.textContent = section.content || "";
          event.target.textContent = "Show less";
        }
        event.stopPropagation();
      };

      // Filter sections
      function filterSections() {
        displaySections();
      }

      // Export current resume
      function exportCurrentResume() {
        if (currentFileIndex === -1) {
          alert("No resume selected");
          return;
        }

        const result = batchData.results[currentFileIndex];
        const dataStr = JSON.stringify(result.result, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });

        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download =
          result.file_name.replace(/\.[^/.]+$/, "") + "_segmented.json";
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
