<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Resume Batch Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --accent: #22c55e;
        --card: #0b1220;
        --border: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(6px);
        z-index: 2;
      }
      header h1 {
        font-size: 16px;
        margin: 0;
        color: var(--muted);
        font-weight: 500;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        width: 100%;
      }
      button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        border-color: var(--muted);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      select,
      .info {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 6px;
      }
      .layout {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 12px;
        height: calc(100vh - 60px);
        padding: 12px;
      }
      .pane {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .pane h2 {
        margin: 0;
        padding: 10px 12px;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        color: var(--muted);
        font-weight: 600;
      }
      .pane .content {
        padding: 0;
        overflow: auto;
        flex: 1;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: 0;
        background: #111;
      }
      .section {
        border-bottom: 1px solid var(--border);
      }
      .section .title {
        padding: 10px 12px;
        cursor: pointer;
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .section .title span {
        color: var(--accent);
        font-weight: 600;
      }
      .section .body {
        padding: 8px 12px;
        display: none;
      }
      .section.open .body {
        display: block;
      }
      ul {
        margin: 6px 0 0 18px;
        padding: 0;
      }
      li {
        margin: 4px 0;
        color: var(--text);
      }
      .contact {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        background: #0c1322;
      }
      .muted {
        color: var(--muted);
      }
      .grow {
        flex: 1 1 auto;
      }
      a {
        color: #93c5fd;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Resume Batch Viewer</h1>
      <div class="controls">
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
        <span id="pos" class="info">0 / 0</span>
        <select id="jumpSel" class="grow"></select>
        <a id="openPdf" class="info" target="_blank" rel="noopener">Open PDF</a>
        <select id="filterExp" title="Filter by Experience">
          <option value="all">Experience: All</option>
          <option value="empty">Experience: None</option>
          <option value="nonempty">Experience: Not null</option>
        </select>
      </div>
    </header>
    <div class="layout">
      <div class="pane">
        <h2>Segmented Sections</h2>
        <div class="content" id="segPane">
          <div id="contact" class="contact"></div>
          <div id="sections"></div>
        </div>
      </div>
      <div class="pane">
        <h2>PDF Preview</h2>
        <div class="content">
          <div
            id="docxNotice"
            style="
              display: none;
              padding: 20px;
              text-align: center;
              color: var(--muted);
            "
          >
            <p>DOCX files cannot be previewed in browser.</p>
            <p>Click "Open PDF" to download and view.</p>
          </div>
          <iframe id="pdfFrame" title="PDF Viewer"></iframe>
        </div>
      </div>
    </div>
    <script>
      const pdfFrame = document.getElementById("pdfFrame");
      const docxNotice = document.getElementById("docxNotice");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const pos = document.getElementById("pos");
      const jumpSel = document.getElementById("jumpSel");
      const openPdf = document.getElementById("openPdf");
      const filterExp = document.getElementById("filterExp");

      const contactBox = document.getElementById("contact");
      const sectionsBox = document.getElementById("sections");

      let rows = [];
      let idx = 0;
      let currentFilter = localStorage.getItem("expFilter") || "all";
      filterExp.value = currentFilter;

      async function loadRows() {
        const url = `/api/rows?experience=${encodeURIComponent(currentFilter)}`;
        const res = await fetch(url);
        rows = await res.json();
        jumpSel.innerHTML = "";
        rows.forEach((r, i) => {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `[${i + 1}] ${r.filename}`;
          jumpSel.appendChild(opt);
        });
        idx = 0;
        render();
      }

      function setPdf(originalIndex, filename) {
        const url = `/pdf/${originalIndex}`;
        const ext = filename.split(".").pop().toLowerCase();

        if (ext === "docx" || ext === "doc") {
          // Show notice for DOCX files
          pdfFrame.style.display = "none";
          docxNotice.style.display = "block";
          pdfFrame.removeAttribute("src");
        } else {
          // Show iframe for PDF and images
          pdfFrame.style.display = "block";
          docxNotice.style.display = "none";
          pdfFrame.src = url;
        }

        openPdf.href = url;
        openPdf.download = filename;
      }

      function renderContact(c) {
        const parts = [];
        if (!c || Object.keys(c).length === 0) {
          contactBox.innerHTML = '<span class="muted">No contact info</span>';
          return;
        }
        const order = [
          "name",
          "email",
          "phone",
          "linkedin",
          "github",
          "location",
        ];
        order.forEach((k) => {
          if (c[k])
            parts.push(
              `<div><span class="muted">${k}:</span> ${escapeHtml(
                String(c[k])
              )}</div>`
            );
        });
        const others = Object.keys(c).filter((k) => !order.includes(k));
        others.forEach((k) =>
          parts.push(
            `<div><span class="muted">${k}:</span> ${escapeHtml(
              String(c[k])
            )}</div>`
          )
        );
        contactBox.innerHTML =
          parts.join("") || '<span class="muted">No contact info</span>';
      }

      function renderSections(secs) {
        sectionsBox.innerHTML = "";
        const keys = Object.keys(secs || {});
        if (keys.length === 0) {
          sectionsBox.innerHTML =
            '<div class="muted" style="padding:10px 12px;">No sections</div>';
          return;
        }
        keys.forEach((k) => {
          const lines = secs[k] || [];
          const wrap = document.createElement("div");
          wrap.className = "section open";
          const title = document.createElement("div");
          title.className = "title";
          title.innerHTML = `<span>${escapeHtml(
            k
          )}</span><small class="muted">${lines.length} lines</small>`;
          const body = document.createElement("div");
          body.className = "body";
          const ul = document.createElement("ul");
          lines.forEach((t) => {
            const li = document.createElement("li");
            li.textContent = t;
            ul.appendChild(li);
          });
          body.appendChild(ul);
          title.addEventListener("click", () => wrap.classList.toggle("open"));
          wrap.appendChild(title);
          wrap.appendChild(body);
          sectionsBox.appendChild(wrap);
        });
      }
      function render() {
        const total = rows.length;
        if (total === 0) {
          pos.textContent = "0 / 0";
          pdfFrame.removeAttribute("src");
          pdfFrame.style.display = "none";
          docxNotice.style.display = "none";
          sectionsBox.innerHTML = "";
          contactBox.innerHTML = '<span class="muted">No rows</span>';
          return;
        }
        if (idx < 0) idx = 0;
        if (idx >= total) idx = total - 1;
        pos.textContent = `${idx + 1} / ${total}`;
        jumpSel.value = String(idx);
        const row = rows[idx];
        // Use server-provided original index to keep PDF and details in sync
        setPdf(row.i, row.filename);
        renderContact(row.contact);
        renderSections(row.sections);
        prevBtn.disabled = idx === 0;
        nextBtn.disabled = idx === total - 1;
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      prevBtn.addEventListener("click", () => {
        idx--;
        render();
      });
      nextBtn.addEventListener("click", () => {
        idx++;
        render();
      });
      jumpSel.addEventListener("change", () => {
        idx = parseInt(jumpSel.value || "0", 10) || 0;
        render();
      });
      filterExp.addEventListener("change", () => {
        currentFilter = filterExp.value;
        localStorage.setItem("expFilter", currentFilter);
        loadRows();
      });

      loadRows().catch((err) => {
        console.error(err);
        contactBox.innerHTML = '<span class="muted">Failed to load rows</span>';
      });
    </script>
  </body>
</html>
